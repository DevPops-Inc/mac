#!/bin/bash
set -e

# check Malwarebytes on Mac

desktopApp="Malwarebytes.app"

check_os_for_mac() { 
    echo "Started checking operating system at $(date)"

    if [[ $OSTYPE == 'darwin'* ]]; then 
        tput setaf 2; echo -e "Operating System:\n$(sw_vers)"; tput sgr0

        echo "Finished checking operating system at $(date)"
        echo ""
    else 
        tput setaf 1; echo "Sorry but this script only runs on Mac."; tput sgr0

        echo "Finished checking operating system at $(date)"
        echo ""

        exit 1
    fi
}

get_desktop_app() {
	if [ -z "$desktopApp" ]; then 
		read -p "Please type the name of the desktop app you want to check and press \"return\" key (Example: Malwarebytes.app): " desktopApp
		
		echo ""

		for app in `ls /Applications | grep "$desktopApp"`; do 
			echo "$app" &>/dev/null
		done 

	else 
		echo $desktopApp &>/dev/null
	fi
}

check_parameters() {
	echo "Started checking parameter(s) at $(date)"
	valid="true"
		
	echo "Parameter(s):"
	echo "-----------------------"
	echo "desktopApp: $desktopApp"
	echo "-----------------------"
	
	if [ -z "$desktopApp" ]; then 
		tput setaf 1; echo "desktopApp is not set."; tput sgr0
		valid="false"
	fi
	
	if [ $valid == "true" ]; then 
		tput setaf 2; echo "All parameter check(s) passed."; tput sgr0

		echo "Finished checking parameter(s) at $(date)"
		echo ""
	else 
		tput setaf 1; echo "One or more parameters are incorrect."; tput sgr0
		
		echo "Finished checking parameter(s) at $(date)"
		echo ""

		exit 1
	fi
}

check_malwarebytes() {
    printf "\nCheck Malwarebytes on Mac.\n\n"
    check_os_for_mac

    get_desktop_app
    check_parameters

    start=$(date +%s)
    echo "Started checking Malwarebytes at $(date)"

    if open -Ra "$desktopApp"; then 
        tput setaf 2; echo "Malwarebytes is installed."; tput sgr0
        
        end=$(date +%s)
        echo "Finished checking Malwarebytes at $(date)"

        duration=$(( $end - $start ))
        echo "Total execution time: $duration second(s)"
        echo ""
    else 
        tput setaf 1; echo "Malwarebytes is not installed."; tput sgr0

        end=$(date +%s)
        echo "Finished checking Malwarebytes at $(date)"

        duration=$(( $end - $start ))
        echo "Total execution time: $duration second(s)"
        echo ""

        exit 1
    fi
}

check_malwarebytes
